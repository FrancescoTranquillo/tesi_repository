```{r, ref.label="grafico",message="F"}
library("ggplot2",verbose = F,quietly = T)
library("viridis",verbose = F,quietly = T)
library(tidyverse)
library(tm)
eq = function(x){3*log(50/x)}

df = data.frame(x=c(4,40), y=eq(c(4,40)), name=c("t[1]", "t[2]"))
ggplot(data.frame(x=c(1, 50)), aes(x=x)) + 
  stat_function(fun=eq, 
                geom="line",
                size=1) +
  labs(x=expression("n"[t]), y="TF-IDF")+
  geom_point(data=df,aes(x=x, y=y) ,col=c("red","blue"),size=3)+
  geom_text(data=df,aes(x=x, y=y,label=name),vjust=-1.35,parse=T, hjust=-.13)+
  theme_minimal()


```





```{r}
library(magrittr)
library(viridis)
library(ggthemes)
library(hrbrthemes)
library(cowplot)
df2 <- read.csv2("tabella_scontrini_text.csv",stringsAsFactors = F)

df2$testo <- iconv(df2$testo,"UTF-8", "UTF-8",sub='')

clean_corpus <- function(corpus) {
  corpus <- tm_map(corpus, stripWhitespace)
  corpus <- tm_map(corpus, removePunctuation)
  corpus <- tm_map(corpus, content_transformer(tolower))
  corpus <- tm_map(corpus, removeNumbers)
  
  # corpus <- tm_map(corpus, stemDocument)
}


corpus <- VCorpus(VectorSource(df2$testo)) %>%
    clean_corpus(.)
  bag_dtm <- as.data.frame(as.matrix(DocumentTermMatrix(
    corpus,
    control = list(weighting = function(x) weightTfIdf(x))
  )))
  tfidf <- summarise_all(bag_dtm, mean, na.rm = T)

  tdm <- TermDocumentMatrix(corpus)
  
wordFreq=data.frame(apply(tdm,1,sum))
names(wordFreq)="Frequency"
wordFreq$Terms=row.names(wordFreq)


row.names(wordFreq)=NULL
wordFreq=wordFreq[,c(2,1)]

wordFreq %<>% mutate(irregolare=factor(ifelse(Terms%in%c("irregolare", "allarme", "scollegato", "otturato"),yes = 1,no = 0))) %>% 
  mutate(tick.color=ifelse(irregolare==1, "red4","black"))

subset <- subset(wordFreq, irregolare==1)

wordFreq <- top_n(n=40, wt=Frequency,x=wordFreq)
wordFreq$Terms <- factor(wordFreq$Terms)
colors <- wordFreq$tick.color[order(wordFreq$Frequency)]
ggplot(wordFreq,
       aes(x = reorder(Terms, Frequency), Frequency, fill = irregolare)) +
       geom_bar(stat = "identity", color = "black",alpha=1) +
       scale_fill_manual(values = c("0" = "lightblue", "1" = "red4")) +
       labs(x = "Parole", y = "Frequenza nel corpus") +
       geom_text(
       data = subset,
       aes(
       x = reorder(Terms, Frequency),
       y = Frequency,
       label = Frequency
       
       ),
       inherit.aes = F,
       vjust = 0.28,
       hjust = -0.19,
       size =3 ,
       color="red4"
       ) +  theme_clean()+
       coord_flip() + guides(fill = F) +
       theme(axis.text.y = element_text(color = colors,size=10))
```


